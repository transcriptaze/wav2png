<!DOCTYPE html>

<html>
  <head>
    <title>wav2png</title>
    <meta charset="utf-8">
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="./css/wav2png.css"  type="text/css" id="css_wav2png">
  </head>

  <body>
    <img id="logo" src="/images/logo.png" />
    <div id="samples">
      <ul>
        <li><a href="/audio/noise.wav" onclick="onSample(event)">noise</a></li>
        <li><a href="/audio/chirp.wav" onclick="onSample(event)">chirp</a></li>
        <li><a href="/audio/clicks.wav" onclick="onSample(event)">clicks</a></li>
        <li><a href="/audio/clocks.wav" onclick="onSample(event)">clocks</a></li>
      </ul>
    </div>
    <main>
      <div id="overview">
        <canvas width="1920" height="256"></canvas>
      </div>
  
      <div id="workspace">
        <div id="canvas">
          <canvas width="1920" height="1080"></canvas>
          <div id="picker" class="overlay" 
                           onclick="onPick(event)" 
                           ondragover="onDragOver(event)" 
                           ondragleave="onDragLeave(event"
                           ondrop="onDrop(event)">
            <input type="file" 
                   accept="audio/wav,audio/x-wav,audio/ogg,audio/aac,audio/opus,audio/3gpp,audio/3gpp2" 
                   onchange="onPicked(event)" 
                   style="display:none;" />          
            <span id="windmill"></span>
          </div>
        </div>
      </div>

      <div id="toolbar" class="toolbar">
        <button id="save" disabled>
          <img src="/images/save.svg" onclick="onDownload(event)" draggable="false" />
        </button>
        <button id="clear" disabled>
          <img src="/images/trash.svg" onclick="onTrash(event)" draggable="false" />
        </button>
        <a id="download" href="" style="display:none" download></a>
      </div>

      <div id="toolbox">
        <wav2png-fill id="fill" colour="#000000ff"></wav2png-fill>
        <wav2png-grid id="grid" color='#00ff00ff'></wav2png-grid>
      </div>

    </main>

    <!-- TEMPLATES -->

    <template id="template-fill">
      <fieldset class="fill">
        <legend>Fill</legend>
        <div>
          <input id="rgb" type="color" value="#000000" />
          <input id="alpha" type="range" step="any" min="0.0" max="1.0" value="1.0" />
        </div>
      </fieldset>
    </template>

    <template id="template-grid">
      <fieldset class="grid">
        <legend>Grid</legend>
        <div>
          <input id="rgb" type="color" value="#00ff00" />
          <input id="alpha" type="range" step="any" min="0.0" max="1.0" value="1.0" />
        </div>
      </fieldset>
    </template>

  </body>

  <script type="module">
    import "./javascript/components/components.js"
    import { initialise, load, download, trash } from './javascript/wav2png.js'

    initialise()

    window.onDragOver = function (event) {
      event.preventDefault()
    }

    window.onDragLeave = function(event) {
      event.preventDefault()
    }

    window.onDrop = function (event) {
      event.preventDefault()

      const audio = /audio\/.*/g
      let files = []

      if (event.dataTransfer.files) {
        files = Array.prototype.map.call(event.dataTransfer.files, f => f)
      } else if (event.dataTransfer.items) {
        files = Array.prototype.filter.call(event.dataTransfer.items, f => f.kind === 'file').map(g => g.getAsFile())
      }

      if (files.length > 0 && audio.test(files[0].type)) {
         load(files[0].name, files[0])
      }
    }
    
    window.onPick = function(event) {
      const picker = document.querySelector('#picker')
      const input = picker.querySelector('input[type="file"]')

      input.value = null
      input.click()
    }

    window.onPicked = function(event) {
      const picker = document.querySelector('#picker')
      const input = picker.querySelector('input[type="file"]')
      const files = input.files

      if (files.length > 0) {
         load(files[0].name, files[0])
      }
    }

    window.onDownload = function(event) {
      download()
    }

    window.onTrash = function(event) {
      trash()
    }

    window.onSample = function (event) {
      event.preventDefault()

      const url = event.currentTarget.href

      return fetch(url)
             .then((response) => {
                if (response.status === 200) {
                  return response.blob()
                } else {
                  throw new Error(`${response.status} ${response.statusText}`)
                }
              })
             .then((blob) => load(url, blob))
             .catch((err) => console.error(err))
    }
  </script>
</html>
